<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Manage Users - Student Utility and Event Management System">
    <title>Manage Users - SUMS</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="dashboard-sidebar-header">
                <a href="../index.html" class="dashboard-brand">
                    <div class="dashboard-logo">SU</div>
                    <div class="dashboard-brand-text">
                        <div class="dashboard-brand-title">Student Utility</div>
                        <div class="dashboard-brand-subtitle">CHARUSAT</div>
                    </div>
                </a>
            </div>

            <nav class="dashboard-nav">
                <div class="dashboard-nav-section">
                    <h3 class="dashboard-nav-title">Main</h3>
                    <ul class="dashboard-nav-list">
                        <li class="dashboard-nav-item">
                            <a href="admin.html" class="dashboard-nav-link">
                                <span class="dashboard-nav-icon">üè†</span>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li class="dashboard-nav-item">
                            <a href="../events/event-list.html" class="dashboard-nav-link">
                                <span class="dashboard-nav-icon">üìÖ</span>
                                <span>All Events</span>
                            </a>
                        </li>
                        <li class="dashboard-nav-item">
                            <a href="manage-users.html" class="dashboard-nav-link active">
                                <span class="dashboard-nav-icon">üë•</span>
                                <span>Manage Users</span>
                            </a>
                        </li>
                        <li class="dashboard-nav-item">
                            <a href="profile.html" class="dashboard-nav-link">
                                <span class="dashboard-nav-icon">üë§</span>
                                <span>My Profile</span>
                            </a>
                        </li>
                        <li class="dashboard-nav-item">
                            <a href="../pages/calendar.html" class="dashboard-nav-link">
                                <span class="dashboard-nav-icon">üìÜ</span>
                                <span>Calendar</span>
                            </a>
                        </li>
                        <li class="dashboard-nav-item">
                            <a href="../pages/help.html" class="dashboard-nav-link">
                                <span class="dashboard-nav-icon">‚ùì</span>
                                <span>Help</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Header -->
            <header class="dashboard-header">
                <div class="dashboard-header-left">
                    <button class="mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <h2 class="dashboard-welcome">Manage Users</h2>
                </div>
                <div class="dashboard-header-right">
                    <div class="dashboard-user">
                        <div class="dashboard-user-avatar" id="userAvatar">AD</div>
                        <div class="dashboard-user-info">
                            <div class="dashboard-user-name" id="userName">Admin</div>
                            <div class="dashboard-user-role">Administrator</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="Auth.logout()">Logout</button>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-change">All roles</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-label">Students</div>
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-change">Active students</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Faculty</div>
                        <div class="stat-value" id="totalFaculty">0</div>
                        <div class="stat-change">Active faculty</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Administrators</div>
                        <div class="stat-value" id="totalAdmins">0</div>
                        <div class="stat-change">System admins</div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="margin-bottom: var(--space-6);">
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        ‚ûï Add New User
                    </button>
                </div>

                <!-- Search and Filter -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <input type="text" id="searchInput" class="form-input" placeholder="Search by name or email..."
                            onkeyup="filterUsers()">
                    </div>
                    <div class="filter-group">
                        <select id="roleFilter" class="form-select" onchange="filterUsers()">
                            <option value="all">All Roles</option>
                            <option value="student">Students</option>
                            <option value="faculty">Faculty</option>
                            <option value="admin">Administrators</option>
                        </select>
                    </div>
                </div>

                <!-- Users Table -->
                <section class="dashboard-section">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal-overlay hidden" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New User</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label for="userName" class="form-label">Full Name *</label>
                        <input type="text" id="userNameInput" class="form-input" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail" class="form-label">Email Address *</label>
                        <input type="email" id="userEmail" class="form-input" placeholder="Enter email" required>
                    </div>
                    <div class="form-group">
                        <label for="userRole" class="form-label">Role *</label>
                        <select id="userRole" class="form-select" required>
                            <option value="">Select role</option>
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userStatus" class="form-label">Status *</label>
                        <select id="userStatus" class="form-select" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveUser()">Save User</button>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Check authentication
        Auth.requireRole('admin');

        // Get current user
        const currentUser = Auth.getCurrentUser();

        // Update user info in header
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userAvatar').textContent = Utils.getInitials(currentUser.name);

        // Sample users data (in a real app, this would come from backend)
        let users = [
            { id: 1, name: 'Raj Patel', email: 'student@charusat.edu.in', role: 'student', status: 'active' },
            { id: 2, name: 'Dr. Priya Shah', email: 'faculty@charusat.edu.in', role: 'faculty', status: 'active' },
            { id: 3, name: 'Admin User', email: 'admin@charusat.edu.in', role: 'admin', status: 'active' },
            { id: 4, name: 'Amit Kumar', email: 'amit.kumar@charusat.edu.in', role: 'student', status: 'active' },
            { id: 5, name: 'Dr. Neha Desai', email: 'neha.desai@charusat.edu.in', role: 'faculty', status: 'active' },
            { id: 6, name: 'Sneha Mehta', email: 'sneha.mehta@charusat.edu.in', role: 'student', status: 'inactive' },
            { id: 7, name: 'Vikram Singh', email: 'vikram.singh@charusat.edu.in', role: 'student', status: 'active' },
            { id: 8, name: 'Dr. Kiran Joshi', email: 'kiran.joshi@charusat.edu.in', role: 'faculty', status: 'active' }
        ];

        let editingUserId = null;

        // Load statistics
        function loadStatistics() {
            const students = users.filter(u => u.role === 'student');
            const faculty = users.filter(u => u.role === 'faculty');
            const admins = users.filter(u => u.role === 'admin');

            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalFaculty').textContent = faculty.length;
            document.getElementById('totalAdmins').textContent = admins.length;
        }

        // Load users table
        function loadUsers(filteredUsers = users) {
            const tbody = document.getElementById('usersTableBody');

            if (filteredUsers.length === 0) {
                tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: var(--space-12);">
              <div class="empty-state-description">No users found</div>
            </td>
          </tr>
        `;
                return;
            }

            tbody.innerHTML = filteredUsers.map(user => {
                const statusBadge = user.status === 'active'
                    ? '<span class="badge badge-success">Active</span>'
                    : '<span class="badge badge-secondary">Inactive</span>';

                const roleBadge = `<span class="badge badge-primary">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span>`;

                return `
          <tr>
            <td><strong>${Utils.escapeHtml(user.name)}</strong></td>
            <td>${Utils.escapeHtml(user.email)}</td>
            <td>${roleBadge}</td>
            <td>${statusBadge}</td>
            <td>
              <button class="btn btn-sm btn-outline" onclick="editUser(${user.id})">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
            </td>
          </tr>
        `;
            }).join('');
        }

        // Filter users
        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;

            let filtered = users;

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(u =>
                    u.name.toLowerCase().includes(searchTerm) ||
                    u.email.toLowerCase().includes(searchTerm)
                );
            }

            // Filter by role
            if (roleFilter !== 'all') {
                filtered = filtered.filter(u => u.role === roleFilter);
            }

            loadUsers(filtered);
        }

        // Show add user modal
        function showAddUserModal() {
            editingUserId = null;
            document.getElementById('modalTitle').textContent = 'Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('userModal').classList.remove('hidden');
        }

        // Edit user
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            editingUserId = userId;
            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('userNameInput').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userStatus').value = user.status;
            document.getElementById('userModal').classList.remove('hidden');
        }

        // Save user
        function saveUser() {
            const name = document.getElementById('userNameInput').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;

            if (!name || !email || !role) {
                Utils.showToast('Please fill all required fields', 'error');
                return;
            }

            if (!Utils.validateEmail(email)) {
                Utils.showToast('Please enter a valid email address', 'error');
                return;
            }

            if (editingUserId) {
                // Update existing user
                const userIndex = users.findIndex(u => u.id === editingUserId);
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], name, email, role, status };
                    Utils.showToast('User updated successfully!', 'success');
                }
            } else {
                // Add new user
                const newUser = {
                    id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                    name,
                    email,
                    role,
                    status
                };
                users.push(newUser);
                Utils.showToast('User added successfully!', 'success');
            }

            closeModal();
            loadStatistics();
            loadUsers();
        }

        // Delete user
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            if (!confirm(`Are you sure you want to delete ${user.name}?`)) return;

            users = users.filter(u => u.id !== userId);
            Utils.showToast('User deleted successfully!', 'success');
            loadStatistics();
            loadUsers();
        }

        // Close modal
        function closeModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('userModal').classList.add('hidden');
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // Initialize
        loadStatistics();
        loadUsers();
    </script>
</body>

</html>