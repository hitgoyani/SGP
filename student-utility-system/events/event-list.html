<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Browse Events - Student Utility and Event Management System">
    <title>Browse Events - SUMS</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="dashboard-sidebar-header">
                <a href="../index.html" class="dashboard-brand">
                    <div class="dashboard-logo">SU</div>
                    <div class="dashboard-brand-text">
                        <div class="dashboard-brand-title">Student Utility</div>
                        <div class="dashboard-brand-subtitle">CHARUSAT</div>
                    </div>
                </a>
            </div>

            <nav class="dashboard-nav">
                <div class="dashboard-nav-section">
                    <h3 class="dashboard-nav-title">Main</h3>
                    <ul class="dashboard-nav-list" id="navList">
                        <!-- Navigation will be loaded based on role -->
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Header -->
            <header class="dashboard-header">
                <div class="dashboard-header-left">
                    <button class="mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <h2 class="dashboard-welcome">Browse Events</h2>
                </div>
                <div class="dashboard-header-right">
                    <div class="dashboard-user">
                        <div class="dashboard-user-avatar" id="userAvatar">U</div>
                        <div class="dashboard-user-info">
                            <div class="dashboard-user-name" id="userName">User</div>
                            <div class="dashboard-user-role" id="userRole">User</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="Auth.logout()">Logout</button>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <input type="text" id="searchInput" class="form-input" placeholder="Search events...">
                    </div>
                    <div class="filter-group">
                        <select id="categoryFilter" class="form-select">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select id="statusFilter" class="form-select">
                            <option value="all">All Status</option>
                            <option value="approved">Approved</option>
                            <option value="pending">Pending</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                </div>

                <!-- Events Grid -->
                <div class="event-list" id="eventsList">
                    <!-- Events will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/events.js"></script>
    <script>
        // Check authentication
        Auth.requireAuth();

        // Get current user
        const currentUser = Auth.getCurrentUser();

        // Update user info
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userAvatar').textContent = Utils.getInitials(currentUser.name);
        document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);

        // Load navigation based on role
        function loadNavigation() {
            const navList = document.getElementById('navList');
            let navItems = '';

            if (currentUser.role === 'student') {
                navItems = `
          <li class="dashboard-nav-item">
            <a href="../dashboards/student.html" class="dashboard-nav-link">
              <span class="dashboard-nav-icon">üè†</span>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="dashboard-nav-item">
            <a href="event-list.html" class="dashboard-nav-link active">
              <span class="dashboard-nav-icon">üìÖ</span>
              <span>Browse Events</span>
            </a>
          </li>
        `;
            } else if (currentUser.role === 'faculty') {
                navItems = `
          <li class="dashboard-nav-item">
            <a href="../dashboards/faculty.html" class="dashboard-nav-link">
              <span class="dashboard-nav-icon">üè†</span>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="dashboard-nav-item">
            <a href="create-event.html" class="dashboard-nav-link">
              <span class="dashboard-nav-icon">‚ûï</span>
              <span>Create Event</span>
            </a>
          </li>
          <li class="dashboard-nav-item">
            <a href="event-list.html" class="dashboard-nav-link active">
              <span class="dashboard-nav-icon">üìÖ</span>
              <span>All Events</span>
            </a>
          </li>
        `;
            } else if (currentUser.role === 'admin') {
                navItems = `
          <li class="dashboard-nav-item">
            <a href="../dashboards/admin.html" class="dashboard-nav-link">
              <span class="dashboard-nav-icon">üè†</span>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="dashboard-nav-item">
            <a href="event-list.html" class="dashboard-nav-link active">
              <span class="dashboard-nav-icon">üìÖ</span>
              <span>All Events</span>
            </a>
          </li>
        `;
            }

            navList.innerHTML = navItems;
        }

        // Load categories
        function loadCategories() {
            const categories = EventManager.getCategories();
            const select = document.getElementById('categoryFilter');
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }

        // Load events
        function loadEvents(filters = {}) {
            let events = currentUser.role === 'student'
                ? EventManager.getApprovedEvents()
                : EventManager.getAllEvents();

            // Apply filters
            events = EventManager.filterEvents(events, filters);
            events = EventManager.sortEvents(events, 'date');

            const container = document.getElementById('eventsList');

            if (events.length === 0) {
                container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3 class="empty-state-title">No Events Found</h3>
            <p class="empty-state-description">Try adjusting your filters</p>
          </div>
        `;
                return;
            }

            container.innerHTML = events.map(event => {
                const isRegistered = currentUser.role === 'student' &&
                    EventManager.isUserRegistered(event.id, currentUser.id);

                return `
          <div class="event-card" onclick="window.location.href='event-detail.html?id=${event.id}'">
            <div class="event-card-header">
              <h3 class="event-card-title">${Utils.escapeHtml(event.title)}</h3>
              <div class="event-card-meta">
                <span class="badge badge-${event.category.toLowerCase()}">${event.category}</span>
                ${event.status !== 'approved' ? `<span class="badge badge-${event.status}">${event.status}</span>` : ''}
                ${isRegistered ? '<span class="badge badge-success">Registered</span>' : ''}
              </div>
            </div>
            <div class="event-card-body">
              <p class="event-card-description">${Utils.escapeHtml(event.description)}</p>
              <div style="margin-top: var(--space-3); color: var(--gray-600); font-size: var(--font-size-sm);">
                <div>üìÖ ${Utils.formatDateShort(event.date)} at ${event.time}</div>
                <div>üìç ${Utils.escapeHtml(event.venue)}</div>
                <div>üë§ ${Utils.escapeHtml(event.organizer)}</div>
              </div>
            </div>
            <div class="event-card-footer">
              <div class="event-card-info">
                <span>üë• ${event.registeredCount}/${event.maxParticipants}</span>
              </div>
              <span class="badge badge-info">${Utils.getDaysUntil(event.date)}</span>
            </div>
          </div>
        `;
            }).join('');
        }

        // Apply filters
        function applyFilters() {
            const filters = {
                search: document.getElementById('searchInput').value,
                category: document.getElementById('categoryFilter').value,
                status: document.getElementById('statusFilter').value
            };
            loadEvents(filters);
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            loadEvents();
        }

        // Search on input
        document.getElementById('searchInput').addEventListener('input',
            Utils.debounce(applyFilters, 300)
        );

        // Toggle sidebar on mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // Initialize
        loadNavigation();
        loadCategories();
        loadEvents();

        // Hide status filter for students
        if (currentUser.role === 'student') {
            document.getElementById('statusFilter').parentElement.style.display = 'none';
        }
    </script>
</body>

</html>